# Copyright (c) 2025, Salesforce, Inc.
# SPDX-License-Identifier: Apache-2
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: Test gateway deployment
templates:
  - gateway/deployment.yaml
release:
  name: spark-gateway
tests:
  - it: Should format bash commands for each gateway.serviceAuth.serviceNames
    set:
      gateway:
        serviceAuth:
          enabled: true
          externalSecret:
            create: true
            secretStoreName: "some-name"
            secretStorePath: "some-path"
          serviceNames:
            - service1
            - service2
          serviceTokenMapPath: /conf/service-auth-config.yaml
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].args
          value:
            - |
              echo "service1: $(cat /etc/secrets/service1)" >> /conf/service-auth-config.yaml
              echo "service2: $(cat /etc/secrets/service2)" >> /conf/service-auth-config.yaml
  - it: Should not have initContainers
    set:
      gateway:
        serviceAuth:
          enabled: false
          serviceNames:
            - service1
            - service2
    asserts:
      - notExists:
          path: spec.template.spec.initContainers
  - it: Should fail if serviceAuth.externalSecret.create and serviceAuth.existingSecretName are not set
    set:
      gateway:
        serviceAuth:
          enabled: true
          externalSecret:
            create: false
          existingSecretName: ""
    asserts:
      - failedTemplate:
          errorMessage: "If gateway.serviceAuth.enabled is 'true' then either gateway.serviceAuth.externalSecret.create must be 'true' or gateway.serviceAuth.existingSecretName must be set."
  - it: Should fail if config.gateway.middleware contains ServiceTokenAuthMiddleware and serviceAuth.enabled is false
    set:
      gateway:
        serviceAuth:
          enabled: False
      config:
        gateway:
          middleware:
            - type: ServiceTokenAuthMiddleware
    asserts:
      - failedTemplate:
          errorMessage: If 'ServiceTokenAuthMiddleware' is configured in .Values.config.gateway.middleware, .Values.gateway.serviceAuth must be enabled and configured
          